#!/bin/bash
# =========================================
# Xray Traffic Monitor & Quota Enforcer
# Based on 3x-ui's AddTraffic periodic job
# Checks traffic usage and disables users when quota exceeded
# Author: LamonLind
# (C) Copyright 2024
# =========================================

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
QUOTA_CONF="/etc/xray/client-quotas.conf"
XRAY_CONFIG="/etc/xray/config.json"
LOG_FILE="/var/log/xray-quota-monitor.log"

# Log message
log_msg() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Get user traffic from xray stats API (like 3x-ui GetXrayTraffic)
# Returns: uplink + downlink in bytes
get_user_traffic() {
    local email="$1"
    local uplink=0
    local downlink=0
    local _Xray="/usr/local/bin/xray"
    
    # Check if xray exists and is executable
    if [ -x "$_Xray" ]; then
        # Get uplink (upload) - handle both "value":"123" and "value": 123 formats
        uplink=$($_Xray api statsquery --server=127.0.0.1:10085 -pattern "user>>>$email>>>traffic>>>uplink" 2>/dev/null | sed -n 's/.*"value"[[:space:]]*:[[:space:]]*"\?\([0-9]\+\)"\?.*/\1/p' | head -1)
        [ -z "$uplink" ] && uplink=0
        
        # Get downlink (download) - handle both "value":"123" and "value": 123 formats
        downlink=$($_Xray api statsquery --server=127.0.0.1:10085 -pattern "user>>>$email>>>traffic>>>downlink" 2>/dev/null | sed -n 's/.*"value"[[:space:]]*:[[:space:]]*"\?\([0-9]\+\)"\?.*/\1/p' | head -1)
        [ -z "$downlink" ] && downlink=0
    fi
    
    # Return total (Up + Down, like 3x-ui)
    echo $((uplink + downlink))
}

# Disable user by removing from xray config (like 3x-ui RemoveUser API call)
disable_user() {
    local email="$1"
    
    # Backup config (rotate backups to save space - keep only last 5)
    local backup_dir="/etc/xray/backups"
    mkdir -p "$backup_dir"
    cp "$XRAY_CONFIG" "$backup_dir/config.json.backup.$(date +%s)"
    
    # Keep only last 5 backups
    ls -t "$backup_dir"/config.json.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -f
    
    # Remove user entries from all protocols
    # VLESS entries
    sed -i "/#vls $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vlsg $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vlsx $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # VMESS entries
    sed -i "/#vms $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vmsg $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vmsx $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/### $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # Trojan entries
    sed -i "/#tr $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#trg $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # Shadowsocks entries
    sed -i "/#ssw $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#sswg $email /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # Mark as disabled in quota config
    sed -i "s/^$email|\\([^|]*\\)|true/$email|\\1|false/" "$QUOTA_CONF"
    
    # Restart xray to apply changes
    systemctl restart xray 2>/dev/null
    
    log_msg "DISABLED: $email (quota exceeded)"
}

# Main monitoring loop (like 3x-ui's XrayTrafficJob.Run)
monitor_quotas() {
    # Check if xray is running
    if ! systemctl is-active --quiet xray; then
        log_msg "Xray service not running, skipping quota check"
        return
    fi
    
    # Check if quota config exists and has entries
    if [ ! -f "$QUOTA_CONF" ] || [ ! -s "$QUOTA_CONF" ]; then
        return
    fi
    
    # Read all quotas
    while IFS='|' read -r email total_bytes enabled; do
        [ -z "$email" ] && continue
        [ "$enabled" != "true" ] && continue
        
        # Validate total_bytes is numeric and not zero
        if ! echo "$total_bytes" | grep -qE '^[0-9]+$' || [ "$total_bytes" -eq 0 ] 2>/dev/null; then
            continue  # Skip unlimited users or invalid entries
        fi
        
        # Get current traffic (Up + Down)
        current_traffic=$(get_user_traffic "$email")
        
        # Log current usage for debugging
        log_msg "User: $email - Usage: $current_traffic bytes / Quota: $total_bytes bytes"
        
        # Check if quota exceeded (like 3x-ui: Up + Down >= Total)
        if [ "$current_traffic" -ge "$total_bytes" ]; then
            log_msg "Quota exceeded: $email ($current_traffic >= $total_bytes bytes)"
            disable_user "$email"
        fi
    done < "$QUOTA_CONF"
}

# Run monitor
monitor_quotas
