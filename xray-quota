#!/bin/bash
# =========================================
# Xray Bandwidth Quota Management System
# Similar to 3x-ui quota implementation
# Author: LamonLind
# (C) Copyright 2024
# =========================================

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration files
QUOTA_LIMITS_FILE="/etc/xray/quota-limits.conf"
QUOTA_USAGE_FILE="/etc/xray/quota-usage.conf"
XRAY_CONFIG="/etc/xray/config.json"
LOG_FILE="/var/log/xray-quota.log"

# Ensure config directory exists
mkdir -p /etc/xray /var/log 2>/dev/null

# Initialize config files if they don't exist
[ ! -f "$QUOTA_LIMITS_FILE" ] && touch "$QUOTA_LIMITS_FILE"
[ ! -f "$QUOTA_USAGE_FILE" ] && touch "$QUOTA_USAGE_FILE"

# Function to log messages
log_message() {
    local level="$1"
    local message="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $message" >> "$LOG_FILE"
}

# Function to convert human-readable size to bytes
# Examples: 1GB -> 1073741824, 500MB -> 524288000
size_to_bytes() {
    local size="$1"
    local number=$(echo "$size" | grep -oP '^\d+(\.\d+)?')
    local unit=$(echo "$size" | grep -oP '[A-Za-z]+$' | tr '[:lower:]' '[:upper:]')
    
    case "$unit" in
        KB) echo $(awk "BEGIN {print int($number * 1024)}") ;;
        MB) echo $(awk "BEGIN {print int($number * 1024 * 1024)}") ;;
        GB) echo $(awk "BEGIN {print int($number * 1024 * 1024 * 1024)}") ;;
        TB) echo $(awk "BEGIN {print int($number * 1024 * 1024 * 1024 * 1024)}") ;;
        *) echo "$number" ;;  # Assume bytes if no unit
    esac
}

# Function to convert bytes to human-readable size
bytes_to_human() {
    local bytes="$1"
    if [ "$bytes" -ge 1099511627776 ]; then
        echo "$(awk "BEGIN {printf \"%.2f TB\", $bytes/1099511627776}")"
    elif [ "$bytes" -ge 1073741824 ]; then
        echo "$(awk "BEGIN {printf \"%.2f GB\", $bytes/1073741824}")"
    elif [ "$bytes" -ge 1048576 ]; then
        echo "$(awk "BEGIN {printf \"%.2f MB\", $bytes/1048576}")"
    elif [ "$bytes" -ge 1024 ]; then
        echo "$(awk "BEGIN {printf \"%.2f KB\", $bytes/1024}")"
    else
        echo "${bytes} Bytes"
    fi
}

# Function to get user traffic from xray stats API
get_user_traffic() {
    local username="$1"
    local uplink=0
    local downlink=0
    
    # Query xray stats using the API
    # Stats format: user>>>username>>>traffic>>>uplink and user>>>username>>>traffic>>>downlink
    if command -v xray &> /dev/null; then
        # Get uplink (data sent by user)
        uplink=$(xray api statsquery --server=127.0.0.1:10085 -pattern "user>>>$username>>>traffic>>>uplink" 2>/dev/null | grep -oP 'value":\K\d+' | head -1)
        [ -z "$uplink" ] && uplink=0
        
        # Get downlink (data received by user)
        downlink=$(xray api statsquery --server=127.0.0.1:10085 -pattern "user>>>$username>>>traffic>>>downlink" 2>/dev/null | grep -oP 'value":\K\d+' | head -1)
        [ -z "$downlink" ] && downlink=0
    fi
    
    # Return total traffic
    echo $((uplink + downlink))
}

# Function to set quota limit for a user
# Usage: set_quota <username> <limit_in_bytes>
set_quota() {
    local username="$1"
    local limit_bytes="$2"
    
    # Remove existing entry if present
    grep -v "^$username|" "$QUOTA_LIMITS_FILE" > "$QUOTA_LIMITS_FILE.tmp" 2>/dev/null
    mv "$QUOTA_LIMITS_FILE.tmp" "$QUOTA_LIMITS_FILE"
    
    # Add new entry: username|limit_bytes|enabled
    echo "$username|$limit_bytes|enabled" >> "$QUOTA_LIMITS_FILE"
    
    log_message "INFO" "Set quota for user $username: $(bytes_to_human $limit_bytes)"
    echo -e "${GREEN}Quota set successfully for $username: $(bytes_to_human $limit_bytes)${NC}"
}

# Function to get quota limit for a user
get_quota_limit() {
    local username="$1"
    grep "^$username|" "$QUOTA_LIMITS_FILE" 2>/dev/null | cut -d'|' -f2
}

# Function to check if user has quota limit
has_quota() {
    local username="$1"
    grep -q "^$username|" "$QUOTA_LIMITS_FILE" 2>/dev/null
}

# Function to remove quota limit for a user
remove_quota() {
    local username="$1"
    grep -v "^$username|" "$QUOTA_LIMITS_FILE" > "$QUOTA_LIMITS_FILE.tmp" 2>/dev/null
    mv "$QUOTA_LIMITS_FILE.tmp" "$QUOTA_LIMITS_FILE"
    
    # Also remove from usage tracking
    grep -v "^$username|" "$QUOTA_USAGE_FILE" > "$QUOTA_USAGE_FILE.tmp" 2>/dev/null
    mv "$QUOTA_USAGE_FILE.tmp" "$QUOTA_USAGE_FILE"
    
    log_message "INFO" "Removed quota for user $username"
    echo -e "${GREEN}Quota removed for $username${NC}"
}

# Function to update usage tracking
update_usage() {
    local username="$1"
    local current_traffic="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Remove old entry
    grep -v "^$username|" "$QUOTA_USAGE_FILE" > "$QUOTA_USAGE_FILE.tmp" 2>/dev/null
    mv "$QUOTA_USAGE_FILE.tmp" "$QUOTA_USAGE_FILE"
    
    # Add new entry: username|current_bytes|last_checked
    echo "$username|$current_traffic|$timestamp" >> "$QUOTA_USAGE_FILE"
}

# Function to disable user in xray config
disable_user() {
    local username="$1"
    
    # Check if user exists in config
    if ! grep -q "\"email\": \"$username\"" "$XRAY_CONFIG" 2>/dev/null; then
        log_message "WARN" "User $username not found in xray config"
        return 1
    fi
    
    # Remove user from xray config (all protocol entries)
    # Backup original config
    cp "$XRAY_CONFIG" "$XRAY_CONFIG.backup.$(date +%s)"
    
    # Remove VLESS entries (#vls, #vlsg, #vlsx)
    sed -i "/#vls $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vlsg $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vlsx $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # Remove VMESS entries (#vms, #vmsg, #vmsx)
    sed -i "/#vms $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vmsg $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#vmsx $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/### $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # Remove Trojan entries (#tr, #trg)
    sed -i "/#tr $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#trg $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # Remove Shadowsocks entries (#ssw, #sswg)
    sed -i "/#ssw $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    sed -i "/#sswg $username /,/},/d" "$XRAY_CONFIG" 2>/dev/null
    
    # Restart xray service to apply changes
    systemctl restart xray 2>/dev/null
    
    log_message "INFO" "Disabled user $username due to quota exceeded"
    echo -e "${RED}User $username disabled - quota exceeded${NC}"
}

# Function to check quota for a specific user
check_user_quota() {
    local username="$1"
    
    # Get quota limit
    local limit=$(get_quota_limit "$username")
    if [ -z "$limit" ]; then
        echo -e "${YELLOW}No quota limit set for $username${NC}"
        return
    fi
    
    # Get current traffic
    local current=$(get_user_traffic "$username")
    
    # Update usage tracking
    update_usage "$username" "$current"
    
    # Calculate percentage
    local percentage=0
    if [ "$limit" -gt 0 ]; then
        percentage=$(awk "BEGIN {printf \"%.1f\", ($current/$limit)*100}")
    fi
    
    # Display status
    echo -e "${BLUE}User:${NC} $username"
    echo -e "${BLUE}Quota Limit:${NC} $(bytes_to_human $limit)"
    echo -e "${BLUE}Used:${NC} $(bytes_to_human $current) (${percentage}%)"
    echo -e "${BLUE}Remaining:${NC} $(bytes_to_human $((limit - current)))"
    
    # Check if quota exceeded
    if [ "$current" -ge "$limit" ]; then
        echo -e "${RED}Status: QUOTA EXCEEDED${NC}"
        return 1
    else
        echo -e "${GREEN}Status: OK${NC}"
        return 0
    fi
}

# Function to check all users with quotas
check_all_quotas() {
    echo -e "${BLUE}=== Checking All User Quotas ===${NC}\n"
    
    local exceeded_count=0
    
    while IFS='|' read -r username limit status; do
        [ -z "$username" ] && continue
        
        echo "----------------------------------------"
        if ! check_user_quota "$username"; then
            # Quota exceeded - take action
            if [ "$status" = "enabled" ]; then
                echo -e "${YELLOW}Taking action: Disabling user $username${NC}"
                disable_user "$username"
                
                # Mark as disabled in limits file
                sed -i "s/^$username|$limit|enabled/$username|$limit|disabled/" "$QUOTA_LIMITS_FILE"
                
                ((exceeded_count++))
            else
                echo -e "${YELLOW}User already disabled${NC}"
            fi
        fi
        echo ""
    done < "$QUOTA_LIMITS_FILE"
    
    echo -e "${BLUE}=== Summary ===${NC}"
    echo -e "Total users checked: $(wc -l < "$QUOTA_LIMITS_FILE")"
    echo -e "Users exceeded quota: $exceeded_count"
    
    log_message "INFO" "Quota check completed. $exceeded_count users exceeded quota."
}

# Function to list all users with quotas
list_quotas() {
    echo -e "${BLUE}=== User Quota Limits ===${NC}\n"
    
    if [ ! -s "$QUOTA_LIMITS_FILE" ]; then
        echo -e "${YELLOW}No users with quota limits${NC}"
        return
    fi
    
    printf "%-20s %-15s %-15s %-10s\n" "Username" "Quota Limit" "Current Usage" "Status"
    printf "%-20s %-15s %-15s %-10s\n" "--------" "-----------" "-------------" "------"
    
    while IFS='|' read -r username limit status; do
        [ -z "$username" ] && continue
        
        local current=$(get_user_traffic "$username")
        local limit_human=$(bytes_to_human $limit)
        local current_human=$(bytes_to_human $current)
        
        printf "%-20s %-15s %-15s %-10s\n" "$username" "$limit_human" "$current_human" "$status"
    done < "$QUOTA_LIMITS_FILE"
}

# Function to reset usage for a user (useful for monthly resets)
reset_usage() {
    local username="$1"
    
    # This would reset the xray stats - requires xray restart or stats reset
    # For now, we'll just log it
    log_message "INFO" "Reset usage requested for $username (requires xray service restart)"
    
    echo -e "${YELLOW}To reset usage, restart xray service:${NC}"
    echo "systemctl restart xray"
}

# Main command handler
case "$1" in
    set)
        # Usage: xray-quota set <username> <limit>
        if [ -z "$2" ] || [ -z "$3" ]; then
            echo -e "${RED}Usage: $0 set <username> <limit>${NC}"
            echo -e "Example: $0 set user1 10GB"
            exit 1
        fi
        limit_bytes=$(size_to_bytes "$3")
        set_quota "$2" "$limit_bytes"
        ;;
    
    remove)
        # Usage: xray-quota remove <username>
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: $0 remove <username>${NC}"
            exit 1
        fi
        remove_quota "$2"
        ;;
    
    check)
        # Usage: xray-quota check [username]
        if [ -z "$2" ]; then
            check_all_quotas
        else
            check_user_quota "$2"
        fi
        ;;
    
    list)
        # Usage: xray-quota list
        list_quotas
        ;;
    
    reset)
        # Usage: xray-quota reset <username>
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: $0 reset <username>${NC}"
            exit 1
        fi
        reset_usage "$2"
        ;;
    
    *)
        echo -e "${BLUE}Xray Bandwidth Quota Management${NC}"
        echo -e "\nUsage: $0 <command> [options]"
        echo -e "\nCommands:"
        echo -e "  set <username> <limit>   - Set quota limit for user (e.g., 10GB, 500MB)"
        echo -e "  remove <username>        - Remove quota limit for user"
        echo -e "  check [username]         - Check quota for user or all users"
        echo -e "  list                     - List all users with quota limits"
        echo -e "  reset <username>         - Reset usage for user"
        echo -e "\nExamples:"
        echo -e "  $0 set user1 10GB        - Set 10GB quota for user1"
        echo -e "  $0 check user1           - Check quota status for user1"
        echo -e "  $0 check                 - Check all users"
        echo -e "  $0 list                  - List all quotas"
        exit 1
        ;;
esac
